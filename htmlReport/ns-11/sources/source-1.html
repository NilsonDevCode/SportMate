


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > DeportesDisponiblesFragment</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.nilson.appsportmate.features.user.ui.deportesdisponibles</a>
</div>

<h1>Coverage Summary for Class: DeportesDisponiblesFragment (com.nilson.appsportmate.features.user.ui.deportesdisponibles)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">DeportesDisponiblesFragment</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/17)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/72)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/124)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.nilson.appsportmate.features.user.ui.deportesdisponibles;
&nbsp;
&nbsp;import android.os.Bundle;
&nbsp;import android.view.LayoutInflater;
&nbsp;import android.view.View;
&nbsp;import android.view.ViewGroup;
&nbsp;import android.widget.Toast;
&nbsp;
&nbsp;import androidx.annotation.NonNull;
&nbsp;import androidx.annotation.Nullable;
&nbsp;import androidx.fragment.app.Fragment;
&nbsp;import androidx.navigation.NavOptions;
&nbsp;import androidx.navigation.Navigation;
&nbsp;import androidx.recyclerview.widget.LinearLayoutManager;
&nbsp;
&nbsp;import com.google.firebase.firestore.DocumentReference;
&nbsp;import com.google.firebase.firestore.DocumentSnapshot;
&nbsp;import com.google.firebase.firestore.FirebaseFirestore;
&nbsp;import com.google.firebase.firestore.Source;
&nbsp;import com.nilson.appsportmate.R;
&nbsp;import com.nilson.appsportmate.common.utils.Preferencias;
&nbsp;import com.nilson.appsportmate.databinding.ActivityDeportesDisponiblesBinding;
&nbsp;import com.nilson.appsportmate.features.townhall.adaptadores.DeportesDisponiblesAdapter;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;
<b class="nc">&nbsp;public class DeportesDisponiblesFragment extends Fragment implements DeportesDisponiblesAdapter.Listener {</b>
&nbsp;
&nbsp;    private ActivityDeportesDisponiblesBinding binding;
&nbsp;
&nbsp;    private FirebaseFirestore db;
&nbsp;    private String ayuntamientoId;
&nbsp;    private String uid;
&nbsp;    private String alias;
&nbsp;
&nbsp;    private String lastAyuntamientoId;
&nbsp;
<b class="nc">&nbsp;    private final List&lt;Map&lt;String, Object&gt;&gt; listaDisponibles = new ArrayList&lt;&gt;();</b>
&nbsp;    private DeportesDisponiblesAdapter adapterDisponibles;
&nbsp;
<b class="nc">&nbsp;    private boolean accionEnProgreso = false;</b>
&nbsp;
&nbsp;    @Nullable
&nbsp;    @Override
&nbsp;    public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) {
<b class="nc">&nbsp;        binding = ActivityDeportesDisponiblesBinding.inflate(inflater, container, false);</b>
<b class="nc">&nbsp;        return binding.getRoot();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) {
<b class="nc">&nbsp;        super.onViewCreated(view, savedInstanceState);</b>
&nbsp;
<b class="nc">&nbsp;        db = FirebaseFirestore.getInstance();</b>
&nbsp;
<b class="nc">&nbsp;        if (getContext() != null) {</b>
<b class="nc">&nbsp;            ayuntamientoId = Preferencias.obtenerAyuntamientoId(getContext());</b>
<b class="nc">&nbsp;            uid            = Preferencias.obtenerUid(getContext());</b>
<b class="nc">&nbsp;            alias          = Preferencias.obtenerAlias(getContext());</b>
<b class="nc">&nbsp;            lastAyuntamientoId = ayuntamientoId;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        binding.rvDisponibles.setLayoutManager(new LinearLayoutManager(requireContext()));</b>
<b class="nc">&nbsp;        adapterDisponibles = new DeportesDisponiblesAdapter(listaDisponibles, this);</b>
<b class="nc">&nbsp;        binding.rvDisponibles.setAdapter(adapterDisponibles);</b>
&nbsp;
&nbsp;        // cargar datos
<b class="nc">&nbsp;        cargarNombreAyuntamiento();</b>
<b class="nc">&nbsp;        cargarDisponibles();</b>
&nbsp;
<b class="nc">&nbsp;        binding.btnSalir.setOnClickListener(v -&gt; {</b>
<b class="nc">&nbsp;            NavOptions opts = new NavOptions.Builder()</b>
<b class="nc">&nbsp;                    .setPopUpTo(R.id.deportesDisponiblesFragment, true)</b>
<b class="nc">&nbsp;                    .build();</b>
<b class="nc">&nbsp;            Navigation.findNavController(v).navigate(R.id.action_global_inicioFragment, null, opts);</b>
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void onResume() {
<b class="nc">&nbsp;        super.onResume();</b>
<b class="nc">&nbsp;        if (getContext() != null) {</b>
<b class="nc">&nbsp;            String nuevo = Preferencias.obtenerAyuntamientoId(getContext());</b>
<b class="nc">&nbsp;            if (nuevo == null ? lastAyuntamientoId != null : !nuevo.equals(lastAyuntamientoId)) {</b>
<b class="nc">&nbsp;                ayuntamientoId = nuevo;</b>
<b class="nc">&nbsp;                lastAyuntamientoId = nuevo;</b>
&nbsp;
&nbsp;                // refrescar encabezado y listas
<b class="nc">&nbsp;                cargarNombreAyuntamiento();</b>
<b class="nc">&nbsp;                listaDisponibles.clear();</b>
<b class="nc">&nbsp;                adapterDisponibles.notifyDataSetChanged();</b>
<b class="nc">&nbsp;                cargarDisponibles();</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /* ===== Encabezado: nombre del ayuntamiento ===== */
&nbsp;    private void cargarNombreAyuntamiento() {
<b class="nc">&nbsp;        if (!isAdded()) return;</b>
&nbsp;
<b class="nc">&nbsp;        if (ayuntamientoId == null || ayuntamientoId.isEmpty()) {</b>
<b class="nc">&nbsp;            binding.tvAytoNombre.setText(&quot;Sin ayuntamiento&quot;);</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        db.collection(&quot;ayuntamientos&quot;)</b>
<b class="nc">&nbsp;                .document(ayuntamientoId)</b>
<b class="nc">&nbsp;                .get(Source.SERVER)</b>
<b class="nc">&nbsp;                .addOnSuccessListener(doc -&gt; {</b>
<b class="nc">&nbsp;                    if (!isAdded()) return;</b>
<b class="nc">&nbsp;                    String nombre = extraerNombreAyuntamiento(doc);</b>
<b class="nc">&nbsp;                    binding.tvAytoNombre.setText(nombre);</b>
&nbsp;                })
<b class="nc">&nbsp;                .addOnFailureListener(e -&gt; {</b>
<b class="nc">&nbsp;                    if (!isAdded()) return;</b>
<b class="nc">&nbsp;                    binding.tvAytoNombre.setText(&quot;(desconocido)&quot;);</b>
&nbsp;                });
&nbsp;    }
&nbsp;
&nbsp;    private String extraerNombreAyuntamiento(DocumentSnapshot doc) {
<b class="nc">&nbsp;        if (doc == null || !doc.exists()) return &quot;(desconocido)&quot;;</b>
<b class="nc">&nbsp;        Object n1 = doc.get(&quot;nombre&quot;);</b>
<b class="nc">&nbsp;        Object n2 = doc.get(&quot;razonSocial&quot;);</b>
<b class="nc">&nbsp;        String nom = n1 != null ? String.valueOf(n1) : null;</b>
<b class="nc">&nbsp;        if (nom == null || nom.trim().isEmpty() || &quot;null&quot;.equalsIgnoreCase(nom)) {</b>
<b class="nc">&nbsp;            nom = n2 != null ? String.valueOf(n2) : &quot;(desconocido)&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        return nom;</b>
&nbsp;    }
&nbsp;
&nbsp;    /* ===== Carga de disponibles ===== */
&nbsp;    private void cargarDisponibles() {
<b class="nc">&nbsp;        if (ayuntamientoId == null || ayuntamientoId.isEmpty()) {</b>
<b class="nc">&nbsp;            binding.tvEmptyDisponibles.setText(&quot;No tienes ayuntamiento asignado.&quot;);</b>
<b class="nc">&nbsp;            binding.tvEmptyDisponibles.setVisibility(View.VISIBLE);</b>
<b class="nc">&nbsp;            binding.rvDisponibles.setVisibility(View.GONE);</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        db.collection(&quot;deportes_ayuntamiento&quot;)</b>
<b class="nc">&nbsp;                .document(ayuntamientoId)</b>
<b class="nc">&nbsp;                .collection(&quot;lista&quot;)</b>
<b class="nc">&nbsp;                .get(Source.SERVER)</b>
<b class="nc">&nbsp;                .addOnSuccessListener(query -&gt; {</b>
<b class="nc">&nbsp;                    listaDisponibles.clear();</b>
<b class="nc">&nbsp;                    for (DocumentSnapshot d : query.getDocuments()) {</b>
<b class="nc">&nbsp;                        Map&lt;String, Object&gt; m = d.getData();</b>
<b class="nc">&nbsp;                        if (m == null) continue;</b>
<b class="nc">&nbsp;                        m = new HashMap&lt;&gt;(m);</b>
<b class="nc">&nbsp;                        m.put(&quot;idDoc&quot;, d.getId());</b>
<b class="nc">&nbsp;                        listaDisponibles.add(m);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    adapterDisponibles.notifyDataSetChanged();</b>
&nbsp;
<b class="nc">&nbsp;                    boolean vacio = listaDisponibles.isEmpty();</b>
<b class="nc">&nbsp;                    binding.tvEmptyDisponibles.setVisibility(vacio ? View.VISIBLE : View.GONE);</b>
<b class="nc">&nbsp;                    binding.rvDisponibles.setVisibility(vacio ? View.GONE : View.VISIBLE);</b>
&nbsp;                })
<b class="nc">&nbsp;                .addOnFailureListener(e -&gt; {</b>
<b class="nc">&nbsp;                    if (!isAdded()) return;</b>
<b class="nc">&nbsp;                    Toast.makeText(requireContext(), &quot;Error cargando disponibles: &quot; + e.getMessage(), Toast.LENGTH_SHORT).show();</b>
&nbsp;                });
&nbsp;    }
&nbsp;
&nbsp;    /* ===== Listener del adapter ===== */
&nbsp;    @Override
&nbsp;    public void onApuntarse(Map&lt;String, Object&gt; deporte) {
<b class="nc">&nbsp;        if (!isAdded()) return;</b>
&nbsp;
<b class="nc">&nbsp;        if (uid == null || uid.isEmpty()) {</b>
<b class="nc">&nbsp;            Toast.makeText(requireContext(), &quot;Inicia sesión para inscribirte&quot;, Toast.LENGTH_SHORT).show();</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        if (accionEnProgreso) return;</b>
<b class="nc">&nbsp;        accionEnProgreso = true;</b>
&nbsp;
<b class="nc">&nbsp;        String docId = String.valueOf(deporte.get(&quot;idDoc&quot;));</b>
<b class="nc">&nbsp;        DocumentReference refDeporte = db.collection(&quot;deportes_ayuntamiento&quot;)</b>
<b class="nc">&nbsp;                .document(ayuntamientoId)</b>
<b class="nc">&nbsp;                .collection(&quot;lista&quot;)</b>
<b class="nc">&nbsp;                .document(docId);</b>
&nbsp;
<b class="nc">&nbsp;        DocumentReference refInscrito = refDeporte.collection(&quot;inscritos&quot;).document(uid);</b>
<b class="nc">&nbsp;        DocumentReference refUser = db.collection(&quot;usuarios&quot;)</b>
<b class="nc">&nbsp;                .document(uid)</b>
<b class="nc">&nbsp;                .collection(&quot;inscripciones&quot;).document(docId);</b>
&nbsp;
<b class="nc">&nbsp;        db.runTransaction(tx -&gt; {</b>
<b class="nc">&nbsp;            DocumentSnapshot snapDeporte = tx.get(refDeporte);</b>
<b class="nc">&nbsp;            Long plazas = snapDeporte.getLong(&quot;plazasDisponibles&quot;);</b>
<b class="nc">&nbsp;            if (plazas == null) plazas = 0L;</b>
<b class="nc">&nbsp;            if (plazas &lt;= 0) throw new IllegalStateException(&quot;NO_PLAZAS&quot;);</b>
&nbsp;
<b class="nc">&nbsp;            DocumentSnapshot snapInscrito = tx.get(refInscrito);</b>
<b class="nc">&nbsp;            if (snapInscrito.exists()) throw new IllegalStateException(&quot;YA_INSCRITO&quot;);</b>
&nbsp;
<b class="nc">&nbsp;            tx.update(refDeporte, &quot;plazasDisponibles&quot;, plazas - 1);</b>
&nbsp;
<b class="nc">&nbsp;            Map&lt;String, Object&gt; ins = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;            ins.put(&quot;uid&quot;, uid);</b>
<b class="nc">&nbsp;            ins.put(&quot;alias&quot;, alias);</b>
<b class="nc">&nbsp;            ins.put(&quot;ts&quot;, System.currentTimeMillis());</b>
<b class="nc">&nbsp;            tx.set(refInscrito, ins);</b>
&nbsp;
<b class="nc">&nbsp;            Map&lt;String, Object&gt; copia = new HashMap&lt;&gt;(deporte);</b>
<b class="nc">&nbsp;            copia.put(&quot;idDoc&quot;, docId);</b>
<b class="nc">&nbsp;            copia.put(&quot;ayuntamientoId&quot;, ayuntamientoId);</b>
<b class="nc">&nbsp;            tx.set(refUser, copia);</b>
&nbsp;
<b class="nc">&nbsp;            return null;</b>
<b class="nc">&nbsp;        }).addOnSuccessListener(unused -&gt; {</b>
<b class="nc">&nbsp;            if (!isAdded()) return;</b>
<b class="nc">&nbsp;            Toast.makeText(requireContext(), &quot;Inscripción realizada&quot;, Toast.LENGTH_SHORT).show();</b>
<b class="nc">&nbsp;            adapterDisponibles.markApuntado(docId); // pinta “Apuntado”</b>
<b class="nc">&nbsp;            cargarDisponibles();                    // refresca plazas</b>
<b class="nc">&nbsp;            accionEnProgreso = false;</b>
<b class="nc">&nbsp;        }).addOnFailureListener(e -&gt; {</b>
<b class="nc">&nbsp;            if (!isAdded()) return;</b>
<b class="nc">&nbsp;            String code = e.getMessage() != null ? e.getMessage() : &quot;&quot;;</b>
<b class="nc">&nbsp;            if (code.contains(&quot;YA_INSCRITO&quot;)) {</b>
<b class="nc">&nbsp;                Toast.makeText(requireContext(), &quot;Solo puedes apuntarte una vez a esta actividad.&quot;, Toast.LENGTH_SHORT).show();</b>
<b class="nc">&nbsp;            } else if (code.contains(&quot;NO_PLAZAS&quot;)) {</b>
<b class="nc">&nbsp;                Toast.makeText(requireContext(), &quot;No hay plazas disponibles.&quot;, Toast.LENGTH_SHORT).show();</b>
&nbsp;            } else {
<b class="nc">&nbsp;                Toast.makeText(requireContext(), &quot;No se pudo inscribir: &quot; + code, Toast.LENGTH_SHORT).show();</b>
&nbsp;            }
<b class="nc">&nbsp;            accionEnProgreso = false;</b>
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void onDestroyView() {
<b class="nc">&nbsp;        super.onDestroyView();</b>
<b class="nc">&nbsp;        binding = null;</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-11-11 18:12</div>
</div>
</body>
</html>
